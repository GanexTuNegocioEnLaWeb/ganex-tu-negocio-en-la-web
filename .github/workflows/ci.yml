name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  # Job 1: Verificar que el c√≥digo compila
  build:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Instalar dependencias
        run: npm ci

      - name: Build del proyecto
        run: npm run build
        env:
          # Variables de entorno necesarias para el build
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}

      - name: Verificar que no hay errores de TypeScript
        run: npx astro check
        continue-on-error: true

  # Job 2: Verificar el tama√±o del PR
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar tama√±o del PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            let additions = 0;
            let deletions = 0;

            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
            });

            const totalChanges = additions + deletions;
            let label = '';
            let message = '';

            if (totalChanges < 200) {
              label = 'size/small';
              message = 'PR peque√±o (< 200 l√≠neas). ¬°Perfecto para revisi√≥n!';
            } else if (totalChanges < 500) {
              label = 'size/medium';
              message = 'PR mediano (200-500 l√≠neas). Considera dividirlo si es posible.';
            } else {
              label = 'size/large';
              message = 'PR grande (> 500 l√≠neas). Fuertemente recomendado dividirlo en PRs m√°s peque√±os.';
            }

            // A√±adir label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

            // Comentar en el PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üìä An√°lisis de Tama√±o del PR\n\n${message}\n\n**Cambios:** +${additions} / -${deletions} l√≠neas\n**Total:** ${totalChanges} l√≠neas`
            });

  # Job 3: Verificar convenciones de commits
  commit-lint:
    name: Commit Message Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar mensajes de commit
        uses: actions/github-script@v7
        with:
          script: |
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const conventionalCommitRegex = /^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,100}/;
            const invalidCommits = [];

            commits.data.forEach(commit => {
              const message = commit.commit.message.split('\n')[0];
              if (!conventionalCommitRegex.test(message)) {
                invalidCommits.push({
                  sha: commit.sha.substring(0, 7),
                  message: message
                });
              }
            });

            if (invalidCommits.length > 0) {
              let comment = '## Mensajes de Commit No Convencionales\n\n';
              comment += 'Los siguientes commits no siguen el formato [Conventional Commits](https://www.conventionalcommits.org/):\n\n';
              
              invalidCommits.forEach(commit => {
                comment += `- \`${commit.sha}\`: ${commit.message}\n`;
              });

              comment += '\n**Formato esperado:** `tipo(scope): descripci√≥n`\n';
              comment += '**Tipos v√°lidos:** feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert\n\n';
              comment += '**Ejemplos:**\n';
              comment += '- `feat(contact): a√±adir formulario de contacto`\n';
              comment += '- `fix(header): corregir men√∫ m√≥vil`\n';
              comment += '- `docs(readme): actualizar instrucciones`\n';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });

              core.setFailed('Algunos commits no siguen Conventional Commits');
            } else {
              core.info('‚úÖ Todos los commits siguen Conventional Commits');
            }

  # Job 4: Verificar archivos modificados
  file-check:
    name: File Changes Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar archivos sensibles
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const sensitiveFiles = [
              '.env',
              'package-lock.json',
              '.github/workflows/'
            ];

            const warnings = [];

            files.forEach(file => {
              // Verificar archivos sensibles
              if (sensitiveFiles.some(sf => file.filename.includes(sf))) {
                warnings.push(`Cambios en archivo sensible: \`${file.filename}\``);
              }

              // Verificar archivos grandes
              if (file.changes > 500) {
                warnings.push(`Archivo grande modificado: \`${file.filename}\` (${file.changes} l√≠neas)`);
              }
            });

            if (warnings.length > 0) {
              let comment = '## Revisi√≥n de Archivos\n\n';
              warnings.forEach(warning => {
                comment += `${warning}\n`;
              });
              comment += '\nPor favor, aseg√∫rate de que estos cambios son intencionales.';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
