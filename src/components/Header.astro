---
import { Image } from "astro:assets";
import logoGanexWhite from "../assets/logo-ganex-white.svg";
import logoGanex from "../assets/logo-ganex.svg";
import LanguageSwitcher from "./LanguageSwitcher.astro";
import { Icon } from "astro-icon/components";

import { getSite } from "../lib/site";
import { getI18nDict, t } from "../lib/i18n";

interface Props {
  lang: string;
  slug: string;
  variant?: "transparent" | "orange";
  class?: string;
}

const {
  lang = "es",
  slug = "home",
  variant = "transparent",
  class: className,
} = Astro.props as Props;

const bgClass =
  variant === "orange" ? "bg-gradient-to-br from-[#ff8a00] to-[#ffb25a]" : "";

const site = await getSite(lang);
const dict = await getI18nDict(lang);

// navegación
const nav = (site?.data.nav ?? []) as Array<{
  label: string;
  slug?: string;
  href?: string;
}>;

// servicios (dropdown)
const services = (site?.data.services ?? []) as Array<{
  title: string;
  slug?: string;
  href?: string;
}>;

const url = new URL(Astro.url);
const currentPath = url.pathname;

function hrefFor(item: { slug?: string; href?: string }) {
  if (item.href) return item.href;
  if (!item.slug || item.slug === "home") return `/${lang}`;
  return `/${lang}/${item.slug}`;
}

const navLabel = t("header.nav", dict);
const openMenu = t("header.aria.open_menu", dict);
const closeMenu = t("header.aria.close_menu", dict);
const cta = t("header.cta", dict);
const contactAnchor = `#${t("nav.contact_id", dict)}`;
const sectionServicesId = t("nav.services_id", dict);
---

<header class:list={["relative", bgClass, className]} id="primary-header">
  <section
    class="max-w-6xl mx-auto flex items-center justify-between py-6 text-white px-12"
  >
    <!-- Logo -->
    <a
      href={`/${lang}`}
      class="transition-all duration-500 hover:scale-110 active:scale-95 group"
    >
      <Image
        src={logoGanexWhite}
        alt={site?.data.ogImageAlt || "Ganex"}
        width={240}
        height={160}
        class="w-40 sm:w-48 md:w-56 lg:w-60 h-auto drop-shadow-2xl transition-all duration-500 group-hover:brightness-110"
      />
    </a>

    <!-- Desktop menu -->
    <nav
      class="hidden xl:flex gap-10 items-center"
      aria-label={navLabel}
      role="navigation"
    >
      <!-- Servicios dropdown -->
      <section class="relative group">
        <a
          href={`/${lang}#${sectionServicesId}`}
          class="nav-link text-base font-medium flex items-center gap-1"
        >
          {t("nav.services", dict)}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 transition-transform group-hover:rotate-180"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"></path>
          </svg>
        </a>

        <div
          class="absolute top-full left-0 mt-2 bg-white text-neutral-800 shadow-2xl rounded-xl px-2 py-2 flex flex-col min-w-60
                 opacity-0 scale-95 invisible z-50
                 transition-all duration-200 ease-out
                 group-hover:opacity-100 group-hover:scale-100 group-hover:visible border border-neutral-100 origin-top-left"
        >
          {
            services.map((service) => (
              <a
                href={hrefFor(service)}
                class="text-sm text-neutral-600 hover:text-[#FF7A00] hover:bg-orange-50 px-4 py-3 rounded-lg
                       transition-colors font-medium flex items-center justify-between group/item"
              >
                {service.title}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 opacity-0 -translate-x-2 group-hover/item:opacity-100 group-hover/item:translate-x-0 transition-all"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            ))
          }
        </div>
      </section>

      <!-- Resto del nav -->
      {
        nav.map((item) => {
          const href = hrefFor(item);
          const isActive = currentPath === new URL(href, url).pathname;

          return (
            <a
              href={href}
              aria-current={isActive ? "page" : undefined}
              class={`nav-link text-base font-medium transition-colors ${
                isActive ? "underline" : "hover:text-white/80"
              }`}
            >
              {item.label}
            </a>
          );
        })
      }
    </nav>

    <!-- CTA + Lang -->
    <div class="hidden xl:flex items-center gap-4">
      <a
        href={`${currentPath}${contactAnchor}`}
        class="px-6 py-2.5 bg-white text-[#FF7A00] rounded-full font-bold shadow-lg
               hover:shadow-xl hover:scale-105 transition-all duration-300"
      >
        {cta}
      </a>
      <LanguageSwitcher lang={lang} slug={slug} />
    </div>

    <!-- Mobile button -->
    <button
      id="menu-btn"
      class="xl:hidden p-2 text-white hover:bg-white/10 rounded-xl transition-all active:scale-90"
      aria-label={openMenu}
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <Icon name="tabler:menu-2" class="w-8 h-8 md:w-9 md:h-9" />
    </button>
  </section>
</header>

<div
  id="secondary-header"
  class="fixed left-0 w-full bg-white shadow-xl z-40 -top-40 pointer-events-none transition-all"
>
  <div class="max-w-6xl mx-auto px-12 py-3 flex items-center justify-between">
    <a href={`/${lang}`} class="w-60 transition-transform hover:scale-105">
      <Image
        src={logoGanex}
        alt={site?.data.ogImageAlt || "Ganex"}
        width={240}
        height={160}
        class="drop-shadow-lg"
      />
    </a>

    <nav
      class="hidden xl:flex gap-10 items-center"
      aria-label={navLabel}
      role="navigation"
    >
      <!-- Servicios dropdown -->
      <section class="relative group">
        <a
          href={`/${lang}#${sectionServicesId}`}
          class="nav-link text-base font-medium flex items-center gap-1"
        >
          {t("nav.services", dict)}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 transition-transform group-hover:rotate-180"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"></path>
          </svg>
        </a>

        <div
          class="absolute top-full left-0 mt-2 bg-white text-neutral-800 shadow-2xl rounded-xl px-2 py-2 flex flex-col min-w-60
                 opacity-0 scale-95 invisible z-50
                 transition-all duration-200 ease-out
                 group-hover:opacity-100 group-hover:scale-100 group-hover:visible border border-neutral-100 origin-top-left"
        >
          {
            services.map((service) => (
              <a
                href={hrefFor(service)}
                class="text-sm text-neutral-600 hover:text-[#FF7A00] hover:bg-orange-50 px-4 py-3 rounded-lg
                       transition-colors font-medium flex items-center justify-between group/item"
              >
                {service.title}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 opacity-0 -translate-x-2 group-hover/item:opacity-100 group-hover/item:translate-x-0 transition-all"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            ))
          }
        </div>
      </section>

      <!-- Resto del nav -->
      {
        nav.map((item) => {
          const href = hrefFor(item);
          const isActive = currentPath === new URL(href, url).pathname;

          return (
            <a
              href={href}
              aria-current={isActive ? "page" : undefined}
              class={`nav-link text-base font-medium transition-colors ${
                isActive ? "underline" : "hover:text-white/80"
              }`}
            >
              {item.label}
            </a>
          );
        })
      }
    </nav>

    <div class="hidden xl:flex items-center gap-4">
      <a
        href={`${currentPath}${contactAnchor}`}
        class="px-4 py-2 bg-[#FF8A00] text-white rounded-full font-bold shadow-lg hover:shadow-xl transition-all"
      >
        {cta}
      </a>
      <LanguageSwitcher lang={lang} slug={slug} theme="dark" />
    </div>
    <!-- Mobile button -->
    <button
      id="menu-btn-2"
      class="xl:hidden p-2 text-[#FF8A00] hover:bg-orange-50 rounded-xl transition-all active:scale-90"
      aria-label={openMenu}
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <Icon name="tabler:menu-2" class="w-8 h-8 md:w-9 md:h-9" />
    </button>
  </div>
  <style>
    #secondary-header .nav-link {
      color: #171717;
    }
    #secondary-header .nav-link::after {
      background: #ff8a00;
    }
    #secondary-header.visible {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</div>
<!-- Mobile menu -->
<div
  id="mobile-menu"
  class="fixed inset-0 bg-linear-to-br from-[#ff8a00] to-[#ffb25a] flex flex-col items-center justify-center gap-10
         opacity-0 pointer-events-none transition-all duration-500 z-100 backdrop-blur-lg"
>
  <div class="absolute inset-0 bg-white/5 opacity-20"></div>

  <button
    id="close-menu"
    class="absolute top-8 right-8 text-white p-3 hover:bg-white/20 rounded-2xl transition-all active:scale-90 z-10"
    aria-label={closeMenu}
  >
    <Icon name="tabler:x" class="w-9 h-9" />
  </button>

  <div class="flex flex-col items-center gap-8 z-10 w-full px-12">
    {
      nav.map((item) => (
        <a
          href={hrefFor(item)}
          class="mobile-nav-link text-3xl text-white font-bold tracking-tight hover:scale-110 transition-transform"
        >
          {item.label}
        </a>
      ))
    }

    <div
      class="mt-4 pt-8 border-t border-white/20 w-full flex flex-col items-center gap-8"
    >
      <LanguageSwitcher lang={lang} slug={slug} />

      <a
        href={`${currentPath}${contactAnchor}`}
        class="w-full max-w-xs py-4 bg-white text-[#FF8A00] rounded-2xl font-black text-xl text-center shadow-2xl
               hover:scale-105 active:scale-95 transition-all"
      >
        {cta}
      </a>
    </div>
  </div>
</div>

<script>
  const btn = document.getElementById("menu-btn");
  const btn2 = document.getElementById("menu-btn-2");
  const close = document.getElementById("close-menu");
  const menu = document.getElementById("mobile-menu");

  const toggleMenu = (open: boolean) => {
    if (open) {
      menu?.classList.remove(
        "opacity-0",
        "pointer-events-none",
        "translate-y-10",
      );
      menu?.classList.add("opacity-100", "translate-y-0");
      document.body.style.overflow = "hidden";
    } else {
      menu?.classList.add("opacity-0", "pointer-events-none", "translate-y-10");
      menu?.classList.remove("opacity-100", "translate-y-0");
      document.body.style.overflow = "";
    }
    btn?.setAttribute("aria-expanded", String(open));
    btn2?.setAttribute("aria-expanded", String(open));
  };

  btn?.addEventListener("click", () => toggleMenu(true));
  btn2?.addEventListener("click", () => toggleMenu(true));
  close?.addEventListener("click", () => toggleMenu(false));

  // Dynamic Scroll Behavior (Headroom-style)
  const secondary = document.getElementById("secondary-header");
  let lastScrollY = window.scrollY;
  const threshold = 300; // Distancia mínima para activar el header secundario

  window.addEventListener(
    "scroll",
    () => {
      const currentScrollY = window.scrollY;
      const scrollingDown = currentScrollY > lastScrollY;

      // Si estamos por debajo del threshold
      if (currentScrollY > threshold) {
        if (scrollingDown) {
          // Scroll hacia abajo: ocultar
          secondary?.classList.remove("top-0");
          secondary?.classList.add("-top-60", "pointer-events-none");
        } else {
          // Scroll hacia arriba: mostrar
          secondary?.classList.add("top-0");
          secondary?.classList.remove("-top-60", "pointer-events-none");
        }
      } else {
        // Si estamos muy arriba (cerca del primary header): ocultar secundario
        secondary?.classList.remove("top-0");
        secondary?.classList.add("-top-60", "pointer-events-none");
      }

      lastScrollY = currentScrollY;
    },
    { passive: true },
  );
</script>

<style>
  .nav-link {
    position: relative;
    color: white;
    text-decoration: none;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: -4px;
    width: 100%;
    height: 2px;
    background: currentColor;
    transform: scaleX(0);
    transition: transform 0.4s ease;
  }

  .nav-link:hover::after,
  .nav-link[aria-current="page"]::after {
    transform: scaleX(1);
  }
</style>
