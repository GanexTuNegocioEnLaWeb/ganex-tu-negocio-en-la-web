---
import { getCollection } from "astro:content";
import { getSupportedLangs } from "../lib/i18n";
import { Icon } from "astro-icon/components";

interface Props {
  lang: string;
  slug: string;
  theme?: "light" | "dark";
}

const { lang = "es", slug = "home", theme = "light" } = Astro.props as Props;

const supported = await getSupportedLangs();
const pages = await getCollection("pages");

const blogEntries = await getCollection("blog");
const projectEntries = await getCollection("projects");

function normalize(s: string) {
  return s.replace(/^\/+|\/+$/g, "");
}

function buildHref(targetLang: string) {
  const urlObj = new URL(Astro.url);
  const parts = urlObj.pathname.split("/").filter(Boolean);
  const currentLangInUrl = supported.includes(parts[0]) ? parts[0] : null;
  const rest = currentLangInUrl ? parts.slice(1) : parts;
  const currentPath = rest.join("/");

  // Caso 1: Buscar en la colecci칩n de p치ginas (home, nosotros, etc)
  const currentEntryBySlug = pages.find((p) => p.id === `${slug}.${lang}`);
  const currentEntryByRoute = pages.find(
    (p) =>
      p.id.endsWith(`.${lang}`) &&
      normalize(p.data.route ?? "") === normalize(currentPath),
  );

  const baseSlug =
    currentEntryBySlug?.id.split(".")[0] ||
    currentEntryByRoute?.id.split(".")[0];

  if (baseSlug) {
    const targetEntry = pages.find((p) => p.id === `${baseSlug}.${targetLang}`);
    if (targetEntry) {
      const route =
        targetEntry.data.route ?? (baseSlug === "home" ? "" : baseSlug);
      const seg = normalize(route);
      return `/${targetLang}${seg ? `/${seg}` : ""}`;
    }
  }

  // Caso 2: Buscar en la colecci칩n de Blog
  const blogSlugs = ["blog"];
  const isInBlog = blogSlugs.some((s) =>
    currentPath.toLowerCase().startsWith(s),
  );

  if (isInBlog) {
    const blogParts = currentPath.split("/");
    if (blogParts.length > 1) {
      // Detalle de post: blog/mi-post
      const postSlug = blogParts[1];
      const currentPost = blogEntries.find(
        (e) =>
          e.data.lang === lang &&
          e.slug.replace(new RegExp(`${lang}$`), "") === postSlug,
      );

      if (currentPost) {
        // Encontrar el equivalente en el idioma destino
        // Asumimos que el "id" base sin el sufijo de idioma es el mismo
        const baseId = currentPost.id.split(".")[0];
        const targetPost = blogEntries.find(
          (e) => e.data.lang === targetLang && e.id.startsWith(baseId),
        );

        if (targetPost) {
          const targetPostSlug = targetPost.slug.replace(
            new RegExp(`${targetLang}$`),
            "",
          );
          return `/${targetLang}/blog/${targetPostSlug}`;
        }
      }
    }
    return `/${targetLang}/blog`;
  }

  // Caso 3: Buscar en la colecci칩n de Proyectos
  const projectSlugs = ["proyectos", "portfolio", "projects"];
  const isInProjects = projectSlugs.some((s) =>
    currentPath.toLowerCase().startsWith(s),
  );

  if (isInProjects) {
    const projParts = currentPath.split("/");
    if (projParts.length > 1) {
      // Detalle de proyecto: proyectos/mi-proyecto
      const projectSlug = projParts[1];
      const currentProj = projectEntries.find(
        (e) =>
          e.data.lang === lang &&
          e.slug.replace(new RegExp(`${lang}$`), "") === projectSlug,
      );

      if (currentProj) {
        const baseId = currentProj.id.split(".")[0];
        const targetProj = projectEntries.find(
          (e) => e.data.lang === targetLang && e.id.startsWith(baseId),
        );

        if (targetProj) {
          const targetProjSlug = targetProj.slug.replace(
            new RegExp(`${targetLang}$`),
            "",
          );
          // Usamos el slug base del idioma destino
          const targetBase = targetLang === "es" ? "proyectos" : "projects";
          return `/${targetLang}/${targetBase}/${targetProjSlug}`;
        }
      }
    }
    const targetBase = targetLang === "es" ? "proyectos" : "projects";
    return `/${targetLang}/${targetBase}`;
  }

  return `/${targetLang}`;
}

const url = new URL(Astro.url);

const items = supported.map((l) => ({
  lang: l,
  href: `${buildHref(l)}${url.search}${url.hash}`,
}));

const buttonClass =
  theme === "light"
    ? "border-white/30 hover:bg-white/10 text-white"
    : "border-neutral-200 hover:bg-neutral-100 text-neutral-800";

const dropdownClass =
  theme === "light"
    ? "bg-black border-white/20 text-white"
    : "bg-white border-neutral-100 text-neutral-800 shadow-xl";

const itemHoverClass =
  theme === "light" ? "hover:bg-white/10" : "hover:bg-neutral-50";
---

<div class="relative">
  <button
    class={`flex items-center gap-2 px-3 py-2 border rounded-md transition-colors ${buttonClass}`}
    aria-haspopup="listbox"
    aria-label="Cambiar idioma"
  >
    <Icon name="tabler:language" class="w-4 h-4" />
    <span class="uppercase text-sm">{lang}</span>
  </button>

  <ul
    class={`absolute z-10 right-0 mt-2 border rounded-md
           opacity-0 pointer-events-none focus-within:opacity-100 focus-within:pointer-events-auto ${dropdownClass}`}
    role="listbox"
  >
    {
      items.map((it) => (
        <li role="option" aria-selected={it.lang === lang}>
          <a
            href={it.href}
            hreflang={it.lang}
            class={`block px-4 py-2 uppercase text-sm transition-colors ${itemHoverClass} ${
              it.lang === lang ? "underline" : ""
            }`}
          >
            {it.lang}
          </a>
        </li>
      ))
    }
  </ul>
</div>

<style>
  .relative:focus-within > ul {
    opacity: 1;
    pointer-events: auto;
  }
</style>
