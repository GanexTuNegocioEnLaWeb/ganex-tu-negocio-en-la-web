---
import "../../../assets/article-styles.css";
import { t } from "../../../lib/i18n";
import { getCollection } from "astro:content";

const {
  i18n = {},
  lang = "es",
  postSlug,
} = Astro.props as {
  i18n?: Record<string, any>;
  lang?: string;
  postSlug?: string;
};

const backToBlog = t("blog.back_to_blog", i18n);
const viewAllPosts = t("blog.view_all_posts", i18n);

// Obtener el post del blog desde la collection
let postEntry = null;
if (postSlug) {
  const posts = await getCollection(
    "blog",
    ({ data }) => data.lang === lang && !data.draft
  );
  postEntry = posts.find((post) => {
    const cleanSlug = post.slug.replace(new RegExp(`${lang}$`), "");
    return cleanSlug === postSlug;
  });
}

if (!postEntry || !postEntry.data.title) {
  const blogRoute = lang === "es" ? "blog" : "blog";
  return Astro.redirect(`/${lang}/${blogRoute}`);
}

const postDetails = postEntry.data;
const { Content } = await postEntry.render();
const formattedDate = new Intl.DateTimeFormat(
  lang === "es" ? "es-ES" : "en-US",
  {
    year: "numeric",
    month: "long",
    day: "numeric",
  }
).format(postDetails.pubDate);

// Generar structured data para Article
const site = await import("../../../lib/site").then((m) => m.getSite(lang));
const base = site?.data?.baseUrl?.replace(/\/$/, "") || "";
const postUrl = `${base}/${lang}/blog/${postSlug}`;
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: postDetails.title,
  description: postDetails.description,
  image: postDetails.image ? `${base}${postDetails.image}` : undefined,
  datePublished: postDetails.pubDate.toISOString(),
  dateModified: postDetails.pubDate.toISOString(),
  author: {
    "@type": "Organization",
    name: postDetails.author || "Ganex",
  },
  publisher: {
    "@type": "Organization",
    name: "Ganex",
    logo: {
      "@type": "ImageObject",
      url: `${base}/og-image.png`,
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": postUrl,
  },
  keywords:
    postDetails.keywords?.join(", ") || postDetails.tags?.join(", ") || "",
  articleSection: postDetails.tags?.[0] || "General",
  inLanguage: lang,
};
---

<section class="py-16 bg-white relative overflow-hidden">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Botón de regreso -->
    <div class="mb-8">
      <a
        href={`/${lang}/blog`}
        class="inline-flex items-center gap-2 text-neutral-600 hover:text-[#FF8A00] transition-colors font-medium"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        {backToBlog}
      </a>
    </div>

    <!-- Imagen destacada -->
    {
      postDetails.image && (
        <figure class="relative w-full h-96 md:h-125 rounded-2xl overflow-hidden mb-8 shadow-xl m-0">
          <img
            src={`${postDetails.image}`}
            alt={postDetails.title || "Artículo"}
            loading="eager"
            decoding="async"
            width="1200"
            height="600"
            class="w-full h-full object-cover"
          />
        </figure>
      )
    }

    <!-- Contenido principal -->
    <article
      class="max-w-none"
      itemscope
      itemtype="https://schema.org/BlogPosting"
    >
      <header class="mb-8">
        <div class="flex items-center gap-3 mb-4 text-sm text-neutral-500">
          <time
            datetime={postDetails.pubDate.toISOString()}
            itemprop="datePublished"
          >
            {formattedDate}
          </time>
          {
            postDetails.author && (
              <>
                <span>•</span>
                <span itemprop="author">{postDetails.author}</span>
              </>
            )
          }
        </div>

        {
          postDetails.tags && postDetails.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {postDetails.tags.map((tag) => (
                <span class="text-xs font-bold text-[#FF8A00] uppercase tracking-wide px-3 py-1 bg-[#FF8A00]/10 rounded-full">
                  {tag}
                </span>
              ))}
            </div>
          )
        }

        <h1
          class="text-4xl md:text-5xl font-bold text-neutral-800 mb-4"
          itemprop="headline"
        >
          {postDetails.title}
        </h1>
        {
          postDetails.description && (
            <p
              class="text-xl text-neutral-600 leading-relaxed"
              itemprop="description"
            >
              {postDetails.description}
            </p>
          )
        }
      </header>

      <!-- Contenido del artículo -->
      <div class="article-content">
        <Content />
      </div>

      <!-- Botones de acción -->
      <div
        class="mt-12 pt-8 border-t border-neutral-200 flex flex-col sm:flex-row gap-4"
      >
        <a
          href={`/${lang}/blog`}
          class="inline-flex items-center justify-center gap-2 px-6 py-3.5 bg-white border-2 border-neutral-300 text-neutral-800 font-bold rounded-lg hover:border-[#FF8A00] hover:text-[#FF8A00] transition-all duration-300 hover:-translate-y-1 hover:shadow-lg"
        >
          {viewAllPosts}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
            ></path>
          </svg>
        </a>
      </div>
    </article>
  </div>
</section>

<script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
