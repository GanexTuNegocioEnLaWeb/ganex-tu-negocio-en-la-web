---
import Layout from "../../layouts/Layout.astro";
import { resolveMeta } from "../../lib/seo";
import { getCollection } from "astro:content";
import PageRenderer from "../../components/PageRenderer.astro";
import { getI18nDict, getSupportedLangs, isLang } from "../../lib/i18n";

export const prerender = false;

const { lang: rawLang, slug } = Astro.params;
const supported = await getSupportedLangs();

if (!rawLang || !isLang(rawLang, supported)) {
  return Astro.redirect("/404");
}

const lang = rawLang;
const slugKey = slug || "home";

// Buscar la página en la colección
const pages = await getCollection("pages", (p) => {
  const [pSlug, pLang] = p.id.split(".");
  // Comparar slug sin slashes extra
  const normalizedPSlug = (p.data.route ?? pSlug).replace(/^\/+|\/+$/g, "");
  const normalizedSlug = (slugKey).replace(/^\/+|\/+$/g, "");
  
  return pLang === lang && normalizedPSlug === normalizedSlug;
});

const page = pages[0];

if (!page) {
  return Astro.redirect("/404");
}

const meta = await resolveMeta({
  slug: slugKey,
  lang,
  canonicalUrl: Astro.url?.href,
});
const i18nDict = await getI18nDict(lang);
---

<Layout lang={lang} slug={slugKey}>
  {
    page?.data.blocks?.length ? (
      <PageRenderer lang={lang} blocks={page.data.blocks} i18n={i18nDict} />
    ) : (
      <section class="max-w-3xl mx-auto px-4 py-12">
        <h1 class="text-3xl font-bold sr-only">{meta.title}</h1>
        <p class="opacity-80">{meta.description}</p>
      </section>
    )
  }
</Layout>
